
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訂單管理系統</title>
  <!-- 引入 Supabase JavaScript 客戶端庫 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* 基本樣式 */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      font-size: 18px;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 26px;
      margin-top: 30px;
      margin-bottom: 15px;
    }
    .input-section {
      background-color: #f0f0f0;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .input-field {
      margin-bottom: 15px;
      font-size: 22px;
    }
    .input-field label {
      display: inline-block;
      width: 120px;
      font-size: 22px;
    }
    .input-field input {
      padding: 8px;
      font-size: 22px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    button {
      padding: 10px 15px;
      font-size: 22px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    button.cancel {
      background-color: #f44336;
    }
    button.cancel:hover {
      background-color: #d32f2f;
    }
    button.edit {
      background-color: #2196F3;
    }
    button.edit:hover {
      background-color: #0b7dda;
    }
    .order-section {
      margin-top: 30px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .order-title {
      font-size: 24px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 22px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    /* 產品建議 */
    .product-suggestions {
      position: absolute;
      background-color: white;
      border: 1px solid #ddd;
      max-height: 400px;
      overflow-y: auto;
      width: 350px;
      z-index: 100;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .suggestion-item:hover {
      background-color: #f0f0f0;
    }
    .suggestion-highlight {
      background-color: #f9f2d0;
      font-weight: bold;
    }
    /* 管理員相關 */
    .admin-button {
      display: none;
      float: right;
      margin-top: 15px;
    }
    .login-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .login-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }
    .login-title {
      font-size: 24px;
      margin-bottom: 15px;
    }
    .admin-link {
      text-align: right;
      margin-top: 20px;
      font-size: 16px;
      color: #666;
      cursor: pointer;
    }
    #logoutLink {
      font-weight: bold;
      margin-top: 5px;
    }
    .loading-indicator {
      text-align: center;
      padding: 20px;
      font-size: 22px;
      color: #666;
    }
    .api-status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .api-status.success {
      color: #4CAF50;
    }
    .api-status.error {
      color: #f44336;
    }
    .admin-section {
      display: none;
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      font-size: 20px;
      background-color: #ddd;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background-color: #fff;
      border: 1px solid #ccc;
      border-bottom: none;
    }
    .tab-content {
      display: none;
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
    }
    .tab-content.active {
      display: block;
    }
    .status-indicator {
      font-size: 18px;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .status-success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .status-error {
      background-color: #ffebee;
      color: #c62828;
    }
    .status-warning {
      background-color: #fff8e1;
      color: #ff8f00;
    }
    .date-filter {
      margin-bottom: 15px;
    }
    .date-filter label {
      font-size: 18px;
      margin-right: 10px;
    }
    .date-filter input,
    .date-filter select {
      padding: 8px;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .refresh-btn {
      background-color: #607d8b;
    }
    .delete-btn {
      background-color: #f44336;
      padding: 5px 10px;
      font-size: 16px;
      margin-left: 10px;
    }
    .delete-btn:hover {
      background-color: #d32f2f;
    }
    .refresh-button {
      background-color: #607d8b;
      float: right;
      margin-right: 20px;
    }
    /* 確認對話框 */
    .confirm-dialog {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .confirm-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 350px;
      text-align: center;
    }
    .confirm-message {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .confirm-btns {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .btn-confirm {
      background-color: #f44336;
    }
    .btn-cancel {
      background-color: #9e9e9e;
    }
    .product-code {
      font-weight: bold;
      color: #2196F3;
    }
    .product-name {
      color: #333;
    }
    .search-info {
      display: block;
      font-size: 14px;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }
    .search-debug {
      color: #999;
      font-size: 12px;
      font-style: italic;
      margin-left: 5px;
    }
    /* 統計表格樣式 */
    .stats-header {
      font-size: 24px;
      margin: 20px 0 10px;
      font-weight: bold;
      color: #333;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .stats-table th, .stats-table td {
      padding: 12px 15px;
      text-align: left;
    }
    .stats-table th {
      background-color: #f8f8f8;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    .stats-table td {
      border-bottom: 1px solid #eee;
    }
    /* 統計區塊：下拉選單排列 */
    .stats-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    /* 只針對「訂單統計」下拉選單進行調整 */
    .stats-control select {
      box-sizing: border-box;
      font-size: 20px;
      height: 40px;
      line-height: 40px;
      padding: 0 10px;
      width: 220px;
    }
  </style>
</head>
<body>
  <h1>訂單管理系統</h1>
  
  <div class="input-section">
    <h2>輸入新訂單</h2>
    <div class="input-field">
      <label for="deliveryDate">到貨日期：</label>
      <input type="date" id="deliveryDate" value="2025-03-20">
    </div>
    <div class="input-field">
      <label for="productCode">搜尋產品：</label>
      <input type="text" id="productCode" placeholder="輸入產品編號、名稱或特徵">
      <span class="search-info">您可以輸入產品編號、名稱、顏色等特徵進行搜尋</span>
      <div id="productSuggestions" class="product-suggestions"></div>
    </div>
    <div class="input-field">
      <label for="quantity">公斤數：</label>
      <input type="number" id="quantity" placeholder="輸入數量">
    </div>
    <button id="createOrderBtn">訂單成立</button>
    <div id="apiStatus" class="api-status">正在載入產品資料...</div>
  </div>
  
  <h2>已成立的訂單 <button id="refreshOrdersBtn" class="refresh-button">刷新訂單</button></h2>
  <div id="ordersContainer">
    <!-- 訂單將在這裡動態生成 -->
  </div>
  
  <!-- 管理員區域 -->
  <div class="admin-section" id="adminSection">
    <h2>管理員功能</h2>
    <div class="tabs">
      <div class="tab active" data-tab="historyTab">歷史訂單</div>
      <div class="tab" data-tab="statsTab">訂單統計</div>
    </div>
    
    <div class="tab-content active" id="historyTab">
      <div class="date-filter">
        <label for="startDate">起始日期：</label>
        <input type="date" id="startDate">
        <label for="endDate">結束日期：</label>
        <input type="date" id="endDate">
        <button id="filterDateBtn">篩選</button>
        <button id="refreshHistoryBtn" class="refresh-btn">刷新</button>
      </div>
      <div id="historyContainer">
        <!-- 歷史訂單將在這裡動態生成 -->
      </div>
    </div>
    
    <!-- 統計區塊 -->
    <div class="tab-content" id="statsTab">
      <div class="stats-control">
        <label for="statsYearSelect">選擇年份：</label>
        <select id="statsYearSelect">
          <!-- 年份 2025 ~ 2035 -->
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
          <option value="2030">2030</option>
          <option value="2031">2031</option>
          <option value="2032">2032</option>
          <option value="2033">2033</option>
          <option value="2034">2034</option>
          <option value="2035">2035</option>
        </select>
        <label for="statsMonthSelect">選擇月份：</label>
        <select id="statsMonthSelect">
          <option value="">全部月份</option>
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
        <button id="generateStatsBtn">生成銷售統計</button>
      </div>
      <div id="statsContainer">
        <!-- 統計數據將在這裡動態生成 -->
      </div>
    </div>
  </div>
  
  <div class="admin-link" id="adminLink">管理員登入</div>
  <div class="admin-link" id="logoutLink" style="display: none; color: #d32f2f;">登出管理員</div>
  
  <div class="login-panel" id="loginPanel">
    <div class="login-form">
      <div class="login-title">管理員登入</div>
      <div class="input-field">
        <label for="adminPassword">密碼：</label>
        <input type="password" id="adminPassword" placeholder="請輸入六位數字密碼">
      </div>
      <button id="loginBtn">登入</button>
      <button class="cancel" id="cancelLoginBtn">取消</button>
    </div>
  </div>
  
  <!-- 確認對話框 -->
  <div id="confirmDialog" class="confirm-dialog">
    <div class="confirm-content">
      <div id="confirmMessage" class="confirm-message">確定要執行此操作嗎？</div>
      <div class="confirm-btns">
        <button id="confirmYes" class="btn-confirm">確定</button>
        <button id="confirmNo" class="btn-cancel">取消</button>
      </div>
    </div>
  </div>
  
  <script>
    // Supabase 設置
    const SUPABASE_URL = 'https://sgboiexvyjdrpfrogxnd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYm9pZXh2eWpkcnBmcm9neG5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0MzgyNjcsImV4cCI6MjA1ODAxNDI2N30.x1rYZMpwxY252JTVUp6HPBgWUNVB-We3Qisgu8V-VVA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DEBUG_MODE = false;
    
    // 全局變數
    let productDatabase = [];
    let orders = {}; // 用於暫存客戶端訂單資料
    let isAdminMode = false;
    const ADMIN_PASSWORD = '010329';
    
    // API 設置
    const API_KEY = 'AIzaSyDu11fq-VdRjXnkQiQHTMgT-AvRnBtjs2I';
    const SPREADSHEET_ID = '1-EJEZBCVI1yKPSsLcgoGqvsCdBHPYzHufJCwvzV1s34';
    const RANGE = '產品清單!A2:B300';
    
    // DOM 元素
    const deliveryDateInput = document.getElementById('deliveryDate');
    const productCodeInput = document.getElementById('productCode');
    const quantityInput = document.getElementById('quantity');
    const createOrderBtn = document.getElementById('createOrderBtn');
    const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
    const ordersContainer = document.getElementById('ordersContainer');
    const productSuggestions = document.getElementById('productSuggestions');
    const adminLink = document.getElementById('adminLink');
    const logoutLink = document.getElementById('logoutLink');
    const loginPanel = document.getElementById('loginPanel');
    const adminPasswordInput = document.getElementById('adminPassword');
    const loginBtn = document.getElementById('loginBtn');
    const cancelLoginBtn = document.getElementById('cancelLoginBtn');
    const apiStatus = document.getElementById('apiStatus');
    const adminSection = document.getElementById('adminSection');
    const historyContainer = document.getElementById('historyContainer');
    const statsContainer = document.getElementById('statsContainer');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const filterDateBtn = document.getElementById('filterDateBtn');
    const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYesBtn = document.getElementById('confirmYes');
    const confirmNoBtn = document.getElementById('confirmNo');
    const statsYearSelect = document.getElementById('statsYearSelect');
    const statsMonthSelect = document.getElementById('statsMonthSelect');
    const generateStatsBtn = document.getElementById('generateStatsBtn');
    
    // 確認對話框功能
    function showConfirmDialog(message, onConfirm, onCancel) {
      confirmMessage.textContent = message;
      confirmDialog.style.display = 'flex';
      confirmYesBtn.onclick = () => { hideConfirmDialog(); if (onConfirm) onConfirm(); };
      confirmNoBtn.onclick = () => { hideConfirmDialog(); if (onCancel) onCancel(); };
    }
    function hideConfirmDialog() { confirmDialog.style.display = 'none'; }
    
    // 頁面載入時初始化
    window.addEventListener('DOMContentLoaded', async () => {
      initializeDate();
      await fetchProductData();
      setupTabEvents();
      await loadTempOrders();
      generateStatsBtn.addEventListener('click', generateStats);
    });
    
    // 載入臨時訂單
    async function loadTempOrders() {
      try {
        ordersContainer.innerHTML = '<div class="loading-indicator">載入臨時訂單中...</div>';
        const { data, error } = await supabase
          .from('temp_orders')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) {
          console.error('載入臨時訂單時出錯:', error);
          ordersContainer.innerHTML = '<div class="loading-indicator">載入訂單時出錯，請稍後重試</div>';
          return;
        }
        if (data && data.length > 0) {
          const groupedOrders = {};
          data.forEach(item => {
            const date = item.order_date;
            if (!groupedOrders[date]) { groupedOrders[date] = []; }
            groupedOrders[date].push({
              id: item.item_id,
              code: item.product_code,
              quantity: item.quantity
            });
          });
          orders = groupedOrders;
          renderOrders();
        } else {
          ordersContainer.innerHTML = '<div class="loading-indicator">尚未有訂單</div>';
        }
      } catch (e) {
        console.error('載入臨時訂單時出錯:', e);
        ordersContainer.innerHTML = '<div class="loading-indicator">載入訂單時出錯，請稍後重試</div>';
      }
    }
    
    // 設置頁籤切換
    function setupTabEvents() {
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tabId).classList.add('active');
        });
      });
    }
    
    productCodeInput.addEventListener('input', handleProductSearch);
    createOrderBtn.addEventListener('click', createOrder);
    refreshOrdersBtn.addEventListener('click', loadTempOrders);
    adminLink.addEventListener('click', showLoginPanel);
    logoutLink.addEventListener('click', handleLogout);
    loginBtn.addEventListener('click', handleAdminLogin);
    cancelLoginBtn.addEventListener('click', hideLoginPanel);
    filterDateBtn.addEventListener('click', () => fetchHistoryOrders(true));
    refreshHistoryBtn.addEventListener('click', () => fetchHistoryOrders(false));
    
    // 從 Google Sheets 獲取產品資料 (使用 encodeURIComponent 處理 RANGE)
    async function fetchProductData() {
      try {
        apiStatus.textContent = '正在從 Spreadsheet 載入產品資料...';
        apiStatus.className = 'api-status';
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`
        );
        if (!response.ok) { throw new Error('無法從 Google Sheets 獲取數據'); }
        const data = await response.json();
        if (data.values && data.values.length > 0) {
          productDatabase = data.values.map(row => ({
            code: row[0],
            name: row[1] || '未命名產品'
          }));
          apiStatus.textContent = '';
          apiStatus.className = 'api-status success';
        } else {
          apiStatus.textContent = '未找到產品資料';
          apiStatus.className = 'api-status error';
          loadFallbackProductData();
        }
      } catch (error) {
        console.error('獲取產品數據時出錯:', error);
        apiStatus.textContent = '載入產品資料失敗，使用備用數據';
        apiStatus.className = 'api-status error';
        loadFallbackProductData();
      }
    }
    
    function loadFallbackProductData() {
      productDatabase = [
        { code: 'P1121020', name: '蘋果' },
        { code: 'P1122030', name: '香蕉' },
        { code: 'P1123040', name: '西瓜' },
        { code: 'P1124050', name: '芒果' },
        { code: 'P1125060', name: '葡萄-紅色' },
        { code: 'P1125070', name: '葡萄-綠色' },
        { code: 'P1126070', name: '櫻桃' },
        { code: 'P1127080', name: '鳳梨' },
        { code: 'P1128090', name: '草莓' },
        { code: 'P1129010', name: '藍莓' },
        { code: 'P1129020', name: '橘子' },
        { code: 'P1129030', name: '柳橙' },
        { code: 'P1129040', name: '奇異果-綠色' },
        { code: 'P1129050', name: '奇異果-黃色' },
        { code: 'P1130010', name: '紫咖啡-小包裝' },
        { code: 'P1130020', name: '紫咖啡-中包裝' },
        { code: 'P1130030', name: '紫咖啡-大包裝' },
        { code: 'P1130040', name: '黑咖啡-小包裝' },
        { code: 'P1130050', name: '黑咖啡-中包裝' },
        { code: 'P1130060', name: '黑咖啡-大包裝' }
      ];
      console.log('已載入備用產品數據');
    }
    
    function handleProductSearch() {
      const searchTerm = productCodeInput.value.trim();
      if (searchTerm === '') {
        productSuggestions.style.display = 'none';
        return;
      }
      if (productDatabase.length === 0) {
        productSuggestions.innerHTML = '<div class="suggestion-item">載入產品資料中...</div>';
        productSuggestions.style.display = 'block';
        return;
      }
      const keywords = searchTerm.split(/[\s,，]+/).filter(keyword => keyword.length > 0);
      const scoredProducts = productDatabase.map(product => {
        let score = 0;
        const productCode = product.code || '';
        const productName = product.name || '';
        if (productCode.includes(searchTerm)) score += 80;
        if (productName.includes(searchTerm)) score += 70;
        for (const keyword of keywords) {
          if (productCode.includes(keyword)) { score += 50; }
          if (productName.includes(keyword)) {
            if (/[\u4e00-\u9fa5]/.test(keyword)) { score += 60; }
            else { score += 40; }
          }
        }
        if (searchTerm.includes('咖啡') && productName.includes('咖啡')) { score += 30; }
        return { product, score };
      });
      const relevantProducts = scoredProducts.filter(item => item.score > 0).sort((a, b) => b.score - a.score);
      if (relevantProducts.length > 0) {
        productSuggestions.innerHTML = '';
        productSuggestions.style.display = 'block';
        relevantProducts.forEach(({ product, score }) => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          const productHTML = createHighlightedProduct(product, searchTerm, keywords);
          item.innerHTML = productHTML;
          if (DEBUG_MODE) {
            item.innerHTML += `<span class="search-debug">(分數: ${score})</span>`;
          }
          item.addEventListener('click', () => {
            productCodeInput.value = product.code;
            productSuggestions.style.display = 'none';
          });
          productSuggestions.appendChild(item);
        });
      } else {
        productSuggestions.innerHTML = '<div class="suggestion-item">無符合產品</div>';
        productSuggestions.style.display = 'block';
      }
    }
    
    function createHighlightedProduct(product, searchTerm, keywords) {
      let code = product.code || '';
      let name = product.name || '未命名產品';
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
      function highlightMatches(text, terms) {
        if (!text) return '';
        const tempDiv = document.createElement('div');
        tempDiv.textContent = text;
        const plainText = tempDiv.textContent;
        const sortedTerms = [...terms].sort((a, b) => b.length - a.length);
        const highlightedRanges = [];
        for (const term of sortedTerms) {
          if (!term) continue;
          const pattern = escapeRegExp(term);
          const regex = new RegExp(pattern, 'g');
          let match;
          while ((match = regex.exec(plainText)) !== null) {
            const start = match.index;
            const end = start + match[0].length;
            const overlapping = highlightedRanges.some(range => (start < range.end && end > range.start));
            if (!overlapping) { highlightedRanges.push({ start, end }); }
          }
        }
        highlightedRanges.sort((a, b) => b.start - a.start);
        let result = plainText;
        for (const range of highlightedRanges) {
          result = result.substring(0, range.start) +
                   `<span class="suggestion-highlight">${result.substring(range.start, range.end)}</span>` +
                   result.substring(range.end);
        }
        return result;
      }
      const allTerms = [searchTerm, ...keywords].filter(term => term && term.length > 0);
      code = highlightMatches(code, allTerms);
      name = highlightMatches(name, allTerms);
      return `<span class="product-code">${code}</span> - <span class="product-name">${name}</span>`;
    }
    
    async function createOrder() {
      const date = deliveryDateInput.value;
      const code = productCodeInput.value.trim();
      const quantity = parseFloat(quantityInput.value);
      if (!date) { alert('請選擇到貨日期！'); return; }
      if (!code) { alert('請輸入產品編號！'); return; }
      if (isNaN(quantity) || quantity <= 0) { alert('請輸入有效的數量！'); return; }
      const productExists = productDatabase.some(product => product.code === code);
      if (!productExists) {
        const confirmAdd = confirm(`產品編號 ${code} 不在數據庫中，是否仍要添加？`);
        if (!confirmAdd) { return; }
      }
      const product = productDatabase.find(p => p.code === code);
      const productName = product ? product.name : '未知產品';
      const itemId = Date.now();
      try {
        const { data, error } = await supabase
          .from('temp_orders')
          .insert([{ order_date: date, product_code: code, product_name: productName, quantity: quantity, item_id: itemId }]);
        if (error) {
          console.error('保存臨時訂單時出錯:', error);
          alert('保存訂單時出錯，請稍後重試');
          return;
        }
        productCodeInput.value = '';
        quantityInput.value = '';
        alert('訂單已成功建立！');
        await loadTempOrders();
      } catch (e) {
        console.error('保存臨時訂單時出錯:', e);
        alert('保存訂單時出錯，請稍後重試');
      }
    }
    
    function renderOrders() {
      ordersContainer.innerHTML = '';
      const sortedDates = Object.keys(orders).sort();
      if (sortedDates.length === 0) {
        ordersContainer.innerHTML = '<div class="loading-indicator">尚未有訂單</div>';
        return;
      }
      sortedDates.forEach(date => {
        if (orders[date].length > 0) {
          const orderSection = document.createElement('div');
          orderSection.className = 'order-section';
          const orderTitle = document.createElement('div');
          orderTitle.className = 'order-title';
          orderTitle.textContent = `訂單日期: ${date}`;
          orderSection.appendChild(orderTitle);
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          ['產品編號', '產品名稱', '數量 (公斤)', '操作'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          orders[date].forEach(item => {
            const row = document.createElement('tr');
            const codeCell = document.createElement('td');
            codeCell.textContent = item.code;
            row.appendChild(codeCell);
            const nameCell = document.createElement('td');
            const product = productDatabase.find(p => p.code === item.code);
            nameCell.textContent = product ? product.name : '未知產品';
            row.appendChild(nameCell);
            const quantityCell = document.createElement('td');
            quantityCell.textContent = item.quantity;
            row.appendChild(quantityCell);
            const actionCell = document.createElement('td');
            const editBtn = document.createElement('button');
            editBtn.className = 'edit';
            editBtn.textContent = '編輯';
            editBtn.addEventListener('click', () => confirmEditOrderItem(date, item.id));
            actionCell.appendChild(editBtn);
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel';
            cancelBtn.textContent = '取消';
            cancelBtn.addEventListener('click', () => confirmRemoveOrderItem(date, item.id));
            actionCell.appendChild(cancelBtn);
            row.appendChild(actionCell);
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          orderSection.appendChild(table);
          const adminButton = document.createElement('button');
          adminButton.textContent = '完成訂單';
          adminButton.className = 'admin-button';
          adminButton.addEventListener('click', () => completeOrder(date));
          if (isAdminMode) { adminButton.style.display = 'block'; }
          orderSection.appendChild(adminButton);
          ordersContainer.appendChild(orderSection);
        }
      });
    }
    
    function confirmEditOrderItem(date, itemId) {
      const item = orders[date].find(i => i.id === itemId);
      const product = productDatabase.find(p => p.code === item.code);
      const productName = product ? product.name : '未知產品';
      showConfirmDialog(`確定要編輯 ${productName} (${item.quantity} 公斤) 的訂單嗎？`, () => editOrderItem(date, itemId));
    }
    
    function confirmRemoveOrderItem(date, itemId) {
      const item = orders[date].find(i => i.id === itemId);
      const product = productDatabase.find(p => p.code === item.code);
      const productName = product ? product.name : '未知產品';
      showConfirmDialog(`確定要取消 ${productName} (${item.quantity} 公斤) 的訂單嗎？此操作無法恢復！`, () => removeOrderItem(date, itemId));
    }
    
    function editOrderItem(date, itemId) {
      const item = orders[date].find(i => i.id === itemId);
      if (item) {
        deliveryDateInput.value = date;
        productCodeInput.value = item.code;
        quantityInput.value = item.quantity;
        removeOrderItem(date, itemId, false);
      }
    }
    
    async function removeOrderItem(date, itemId, showConfirm = true) {
      if (showConfirm) {
        confirmRemoveOrderItem(date, itemId);
        return;
      }
      try {
        const { error } = await supabase
          .from('temp_orders')
          .delete()
          .eq('item_id', itemId);
        if (error) {
          console.error('刪除臨時訂單時出錯:', error);
          alert('刪除訂單時出錯，請稍後重試');
          return;
        }
        await loadTempOrders();
      } catch (e) {
        console.error('刪除訂單時出錯:', e);
        alert('刪除訂單時出錯，請稍後重試');
      }
    }
    
    async function completeOrder(date) {
      showConfirmDialog(`確定要完成 ${date} 的所有訂單嗎？這將把訂單從暫存區移至正式訂單。`, async () => {
        try {
          const loadingIndicator = document.createElement('div');
          loadingIndicator.className = 'loading-indicator';
          loadingIndicator.textContent = '正在保存訂單...';
          ordersContainer.appendChild(loadingIndicator);
          const { data: tempOrders, error: queryError } = await supabase
            .from('temp_orders')
            .select('*')
            .eq('order_date', date);
          if (queryError) { throw new Error('獲取臨時訂單數據時出錯: ' + queryError.message); }
          if (!tempOrders || tempOrders.length === 0) { throw new Error('未找到該日期的訂單'); }
          const result = await saveOrderToSupabase(date, tempOrders);
          if (result.success) {
            const itemIds = tempOrders.map(item => item.item_id);
            for (const itemId of itemIds) {
              const { error: deleteError } = await supabase
                .from('temp_orders')
                .delete()
                .eq('item_id', itemId);
              if (deleteError) {
                console.error(`刪除臨時訂單項目 ${itemId} 時出錯:`, deleteError);
              }
            }
            alert(`訂單 ${date} 已完成並保存至資料庫`);
            await loadTempOrders();
            if (adminSection.style.display === 'block') {
              fetchHistoryOrders(false);
            }
          } else {
            throw new Error(result.error || '保存訂單失敗');
          }
        } catch (error) {
          console.error('完成訂單時出錯:', error);
          alert(`保存訂單時出錯: ${error.message || '未知錯誤'}`);
          loadTempOrders();
        }
      });
    }
    
    async function saveOrderToSupabase(date, tempOrders) {
      try {
        console.log(`正在保存 ${date} 的訂單到 Supabase...`);
        const { data: order, error: orderError } = await supabase
          .from('orders')
          .insert([{ order_date: date }])
          .select('id')
          .single();
        if (orderError) {
          console.error('創建訂單記錄時出錯:', orderError);
          return { success: false, error: orderError.message };
        }
        const items = tempOrders.map(item => ({
          order_id: order.id,
          product_code: item.product_code,
          product_name: item.product_name,
          quantity: item.quantity
        }));
        const { error: itemsError } = await supabase
          .from('order_items')
          .insert(items);
        if (itemsError) {
          console.error('創建訂單項目時出錯:', itemsError);
          return { success: false, error: itemsError.message };
        }
        console.log(`訂單 ${date} 已成功保存至 Supabase`);
        return { success: true, orderId: order.id };
      } catch (error) {
        console.error('保存訂單到 Supabase 時出錯:', error);
        return { success: false, error: error.message };
      }
    }
    
    async function fetchHistoryOrders(useFilter) {
      try {
        historyContainer.innerHTML = '<div class="loading-indicator">載入歷史訂單中...</div>';
        let query = supabase
          .from('orders')
          .select('id, order_date, created_at')
          .order('created_at', { ascending: false });
        if (useFilter) {
          const startDate = startDateInput.value;
          const endDate = endDateInput.value;
          if (startDate) { query = query.gte('order_date', startDate); }
          if (endDate) { query = query.lte('order_date', endDate); }
        }
        const { data: ordersData, error: ordersError } = await query;
        if (ordersError) { throw ordersError; }
        if (ordersData.length === 0) {
          historyContainer.innerHTML = '<div class="loading-indicator">沒有歷史訂單記錄</div>';
          return;
        }
        let historyHTML = '';
        for (const order of ordersData) {
          const { data: items, error: itemsError } = await supabase
            .from('order_items')
            .select('*')
            .eq('order_id', order.id);
          if (itemsError) {
            console.error(`獲取訂單 ${order.id} 的項目時出錯:`, itemsError);
            continue;
          }
          const totalQuantity = items.reduce((sum, item) => sum + parseFloat(item.quantity), 0);
          historyHTML += `
            <div class="order-section">
              <div class="order-title">
                訂單日期: ${order.order_date} (總數量: ${totalQuantity} 公斤)
                <button class="delete-btn" data-order-id="${order.id}">刪除訂單</button>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>產品編號</th>
                    <th>產品名稱</th>
                    <th>數量 (公斤)</th>
                  </tr>
                </thead>
                <tbody>`;
          items.forEach(item => {
            historyHTML += `
                  <tr>
                    <td>${item.product_code}</td>
                    <td>${item.product_name}</td>
                    <td>${item.quantity}</td>
                  </tr>`;
          });
          historyHTML += `
                </tbody>
              </table>
            </div>`;
        }
        historyContainer.innerHTML = historyHTML;
        const deleteButtons = historyContainer.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
          button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            confirmDeleteHistoryOrder(orderId);
          });
        });
      } catch (error) {
        console.error('載入歷史訂單時出錯:', error);
        historyContainer.innerHTML = `<div class="status-indicator status-error">
          載入歷史訂單時出錯: ${error.message || '未知錯誤'}
        </div>`;
      }
    }
    
    function confirmDeleteHistoryOrder(orderId) {
      showConfirmDialog(`確定要刪除訂單 #${orderId} 嗎？此操作無法恢復！`, () => deleteHistoryOrder(orderId));
    }
    
    async function deleteHistoryOrder(orderId) {
      if (!orderId) {
        console.error('刪除訂單錯誤: 訂單ID未提供');
        alert('無法刪除訂單: 訂單ID未提供');
        return;
      }
      try {
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'loading-indicator';
        loadingIndicator.textContent = '正在刪除訂單...';
        historyContainer.prepend(loadingIndicator);
        const { error: itemsError } = await supabase
          .from('order_items')
          .delete()
          .eq('order_id', orderId);
        if (itemsError) {
          console.error('刪除訂單項目時出錯:', itemsError);
          throw new Error(`刪除訂單項目時出錯: ${itemsError.message}`);
        }
        const { error: orderError } = await supabase
          .from('orders')
          .delete()
          .eq('id', orderId);
        if (orderError) {
          console.error('刪除訂單記錄時出錯:', orderError);
          throw new Error(`刪除訂單記錄時出錯: ${orderError.message}`);
        }
        alert('訂單已成功刪除');
        fetchHistoryOrders(false);
      } catch (error) {
        console.error('刪除訂單時出錯:', error);
        alert(`刪除訂單時發生錯誤: ${error.message}`);
        fetchHistoryOrders(false);
      }
    }
    
    // 統計功能：根據使用者所選年份及月份（若月份空白則統計全年度）
    async function generateStats() {
      const year = statsYearSelect.value;
      const month = statsMonthSelect.value; // 空字串表示全部月份
      statsContainer.innerHTML = '<div class="loading-indicator">生成銷售統計數據中...</div>';
      const { data, error } = await supabase
        .from('order_items')
        .select(`product_code, product_name, quantity, orders (order_date)`);
      if (error) {
        statsContainer.innerHTML = `<div class="status-indicator status-error">生成統計數據時出錯: ${error.message}</div>`;
        return;
      }
      // 過濾：先取出符合年份的資料，若有選月份則進一步篩選
      const filteredItems = data.filter(item => {
        if (item.orders && item.orders.order_date && item.orders.order_date.startsWith(year)) {
          if (month) {
            // 補零處理：例如 3 -> "03"
            const m = month.padStart(2, '0');
            return item.orders.order_date.substring(5,7) === m;
          }
          return true;
        }
        return false;
      });
      const productStats = {};
      filteredItems.forEach(item => {
        if (!productStats[item.product_code]) {
          productStats[item.product_code] = { code: item.product_code, name: item.product_name, totalQuantity: 0, orderCount: 0 };
        }
        productStats[item.product_code].totalQuantity += parseFloat(item.quantity);
        productStats[item.product_code].orderCount++;
      });
      const sortedStats = Object.values(productStats).sort((a, b) => b.totalQuantity - a.totalQuantity);
      // 取得最大銷售數量，用以計算比例
      const maxQuantity = sortedStats.length > 0 ? Math.max(...sortedStats.map(s => s.totalQuantity)) : 0;
      let statsHTML = '';
      if (month) {
        statsHTML += `<div class="stats-header">${year} 年 ${month} 月產品銷售統計</div>`;
      } else {
        statsHTML += `<div class="stats-header">${year} 年產品銷售統計 (全部月份)</div>`;
      }
      statsHTML += `<table class="stats-table">
                      <thead>
                        <tr>
                          <th>排名</th>
                          <th>產品編號</th>
                          <th>產品名稱</th>
                          <th>總數量 (公斤)</th>
                          <th>訂單次數</th>
                          <th>銷售圖形</th>
                        </tr>
                      </thead>
                      <tbody>`;
      sortedStats.forEach((stat, index) => {
        const barWidth = maxQuantity > 0 ? Math.round((stat.totalQuantity / maxQuantity) * 200) : 0;
        statsHTML += `<tr>
                        <td>${index + 1}</td>
                        <td>${stat.code}</td>
                        <td>${stat.name}</td>
                        <td>${stat.totalQuantity.toFixed(2)}</td>
                        <td>${stat.orderCount}</td>
                        <td><div style="background-color:#4CAF50; height:20px; width:${barWidth}px;"></div></td>
                      </tr>`;
      });
      statsHTML += '</tbody></table>';
      statsContainer.innerHTML = statsHTML;
    }
    
    function showLoginPanel() {
      loginPanel.style.display = 'flex';
      adminPasswordInput.value = '';
    }
    
    function hideLoginPanel() {
      loginPanel.style.display = 'none';
    }
    
    function handleAdminLogin() {
      if (adminPasswordInput.value === ADMIN_PASSWORD) {
        isAdminMode = true;
        hideLoginPanel();
        const adminButtons = document.querySelectorAll('.admin-button');
        adminButtons.forEach(btn => { btn.style.display = 'block'; });
        adminSection.style.display = 'block';
        adminLink.style.display = 'none';
        logoutLink.style.display = 'block';
        fetchHistoryOrders(false);
        alert('已切換至管理員模式');
      } else {
        alert('密碼錯誤');
      }
    }
    
    function handleLogout() {
      isAdminMode = false;
      const adminButtons = document.querySelectorAll('.admin-button');
      adminButtons.forEach(btn => { btn.style.display = 'none'; });
      adminSection.style.display = 'none';
      adminLink.style.display = 'block';
      logoutLink.style.display = 'none';
      alert('已登出管理員模式');
      loadTempOrders();
    }
    
    function initializeDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      deliveryDateInput.value = `${yyyy}-${mm}-${dd}`;
    }
    
    document.addEventListener('click', (e) => {
      if (e.target !== productCodeInput && e.target !== productSuggestions) {
        productSuggestions.style.display = 'none';
      }
    });
  </script>
</body>
</html>
